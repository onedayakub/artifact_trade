# Transfers the ownership of scope:artifact from scope:seller to scope:buyer
# and pays ARTIFACT_PRICE or short_term_gold to scope:seller. Sends interface messages.
at_buy_artifact_interaction_effect = {
	save_scope_value_as = {
		name = artifact_price
		value = $ARTIFACT_PRICE$
	}

	scope:buyer = {
		hidden_effect = {
			send_interface_toast = {
				type = event_generic_neutral
				title = at_msg_artifact_bought
				left_icon = scope:seller
				right_icon = scope:artifact

				show_as_tooltip = {
					at_buy_artifact_effect = yes
				}
			}
		}

		# Warning tooltips
		at_buy_artifact_warning_tooltips_effect = yes
	}

	scope:seller = {
		send_interface_toast = {
			type = event_generic_neutral
			title = at_msg_artifact_sold
			left_icon = scope:buyer
			right_icon = scope:artifact

			at_buy_artifact_effect = yes
		}
	}
}

# Transfers the ownership of scope:artifact from scope:seller to scope:buyer
# and pays scope:artifact_price or short_term_gold to scope:seller.
at_buy_artifact_effect = {
	scope:buyer = {
		# Pay price to seller
		if = {
			limit = {
				short_term_gold >= scope:artifact_price
			}
			pay_short_term_gold = {
				gold = scope:artifact_price
				target = scope:seller
			}
		}
		else = {
			custom_tooltip = at_buyer_not_enough_gold_for_artifact_price_tooltip
			hidden_effect = {
				pay_short_term_gold = {
					gold = short_term_gold
					target = scope:seller
				}
			}
		}

		# Remove buyer claims (tooltip only)
		if = {
			limit = {
				scope:artifact = {
					can_be_claimed_by = scope:buyer
				}
			}
			if = {
				limit = {
					any_personal_claimed_artifact = {
						this = scope:artifact
					}
				}
				show_as_tooltip = {
					remove_personal_artifact_claim = scope:artifact
				}
			}
			else = {
				show_as_tooltip = {
					remove_house_artifact_claim = scope:artifact
				}
			}
		}
	}

	scope:artifact = {
		# Set buyer as new owner
		set_owner = scope:buyer

		hidden_effect = {
			# TODO Mark the artifact as recently bought

			# TODO Trigger event
			#trigger_event = {
			#	on_action = at_on_artifact_bought
			#}
		}
	}
}

# Displays warning tooltips for low durability and useless artifacts.
at_buy_artifact_warning_tooltips_effect = {
	if = {
		limit = {
			scope:artifact = {
				artifact_durability <= define:NInventory|ARTIFACT_LOW_DURABILITY
			}
		}
		custom_tooltip = artifact_gift_low_durability_tt
	}
	if = {
		limit = {
			scope:artifact = {
				artifact_durability <= define:NInventory|ARTIFACT_VERY_LOW_DURABILITY
			}
		}
		custom_tooltip = artifact_gift_very_low_durability_tt
	}
	if = {
		limit = {
			scope:artifact = {
				OR = {
					AND = {
						has_variable = banner_house
						NOT = { var:banner_house = scope:buyer.house }
					}
					AND = {
						has_variable = banner_dynasty
						NOT = { var:banner_dynasty = scope:buyer.dynasty }
					}
				}
			}
		}
		custom_tooltip = artifact_gift_useless_banner_tt
	}
	else_if = {
		limit = {
			scope:buyer = {
				NOR = {
					can_equip_artifact = scope:artifact
					can_benefit_from_artifact = scope:artifact
				}
			}
		}
		custom_tooltip = artifact_gift_useless_tt
	}
	else_if = {
		limit = {
			scope:buyer = {
				NOT = { can_equip_artifact = scope:artifact }
			}
		}
		custom_tooltip = artifact_gift_equip_tt
	}
	else_if = {
		limit = {
			scope:buyer = {
				NOT = { can_benefit_from_artifact = scope:artifact }
			}
		}
		custom_tooltip = artifact_gift_benefit_tt
	}
}

at_get_valid_buyers_or_sellers_effect = {
	save_temporary_scope_as = party
	every_ruler = {
		limit = {
			at_valid_buyer_or_seller_trigger = { PARTY = scope:party }
		}
		add_to_list = $LIST$
	}
}
